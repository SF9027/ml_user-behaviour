# Exploratory data analysis

```{r, echo = FALSE, message = FALSE}
source(here::here("scripts/setup.R"))
```

```{r}
install.packages("summarytools")
library(summarytools)
library(DataExplorer)
```

## Data inspection

### Data check

在这一部分，我们集中展示了所有类型的数据的结构，和简单的graph分析。从结果可以看出，很多数据的分布不均匀，所以之后，针对不同类型的数据，我们用了不同的图表来进行分析。

```{r}
str(Userdataset)
summary(Userdataset)

print(dfSummary(Userdataset,style="grid",
                plain.ascii = FALSE, 
                tmp.img.dir = "/tmp",
                graph.magnif = 0.8),
      method = "render")

```

### Data Attribute Modification

We will divide the data in the data table into two categories， numeric and factor. We will attribute the columns "country", "civilityGenderId", "hasAnyApp", "hasProfilePicture", "langEn", "langFr", "langDe", "langEs", "langIt", "genderFamale", "genderMale" from change numeric to factor. The attributes of the remaining columns are changed from integer to numeric.

```{r}
library(purrr)
library(dplyr)
library(DT)

Userdataset <- as.data.frame(Userdataset)

Userdataset_factor <- Userdataset %>% select(1, 10, 11, 12, 15, 16, 17, 18, 19, 20, 21) %>% colnames()
for(i in Userdataset_factor){
    Userdataset[,i] <- as.factor(Userdataset[,i])
} 

Userdataset_numeric <- Userdataset %>% select(2, 3, 4, 5, 6, 8, 9, 14) %>% colnames()
for(i in Userdataset_numeric){
    Userdataset[,i] <- as.numeric(Userdataset[,i])
} 

        
Userdataset %>% datatable(rownames = FALSE,
                     option = list(scrollX = T,
                                   pageLength = 5))

```

## Data description by using descriptive statistics and graphs

### Graphs for "latent"

The goal of our project is to build the model to predict whether users are latent on this platform. So here we make a comparison of users with latent status and non-latent status.

```{r}

latent <- Userdataset %>% ggplot(mapping = aes(x=latent,fill=latent))+geom_bar()+scale_color_identity()
latent

```
As can be seen from the figure, the data results are extremely unbalanced. However, the result of generating this graph may be caused by our random screening of data. So we will try to use group selection to improve this.

### Graphs for numeric variables

#### Bar-chart

为了看数据的分布情况，我们用bar-chart来展示数字型数据。

```{r}
#Continuous Variables

Userdataset %>% select(productsPassRate) %>% 
keep(is.numeric) %>% 
  gather() %>% 
  ggplot(aes(value)) +
  facet_wrap(~ key, scales = "free") +
  geom_
 # geom_histogram()


```
如图所示，由于大部分user都没有该项数据，所以如图所示，数据极度不平衡。

```{r}
#Discrete variables

Userdataset %>% select(2, 3, 4, 5, 6, 8, 9, 14) %>% 
  keep(is.numeric) %>% 
  gather() %>% 
  ggplot(aes(value)) +
  facet_wrap(~ key, scales = "free") +
  geom_bar()

```
如图所示，由于每个variables的数据都极度分散，差异过大，所以我们并不能很好的将他们可视化出来。

#### Box chart 

```{r}

Userdataset %>% select(2, 3, 4, 5, 6, 7, 8, 9, 14) %>% 
  keep(is.numeric) %>% 
  gather() %>% 
  ggplot(aes(value)) +
  facet_wrap(~ key, scales = "free") +
  geom_boxplot()

```
由于col图的结果不太明显，我们又试着做了箱型图来看数据的差异化。但是由于数据的不均衡，所以结果也差强人意。

### Graphs for non-numeric variables

#### Graph for country variables

针对国家这部分的数据，我们新建了一个dataframe，namedcountry。在这个列表中，我们以国家column为基础，创建了新列，统计了在Userdataset中每个国家出现的次数。新列代表的意思是在该国家中，user的数量。然后我们用不同的表来体现这部分数据。
```{r}

# Bar chart

country <- Userdataset %>% 
  group_by(country) %>%
  summarise(user_count = n())

 p1 <- ggplot(data = country,aes(x = user_count, y = country))+
  geom_col()
p1

```
从图中，我们可以看出user的国家分布也不是很均匀，而且由于国家过于多，我们决定用heatmap的形式来展现该数据。
```{r}

# Heatmap

library(ggplot2)
library(maps)

world_map <- map_data("world")

country <- aggregate(user_count ~ country, data = country, FUN = sum)

country_map <- merge(world_map, country, by.x = "region", by.y = "country", all.x = TRUE)

country_heatmap <- ggplot(country_map, aes(x = long, y = lat, group = group, fill = user_count)) +
  geom_polygon(color = "gray", size = 0.2) +
  scale_fill_gradient(low = "lightblue", high = "darkblue") +
  labs(title = "User Count Heatmap", x = "", y = "") +
  theme_void()

# Display the heatmap
print(country_heatmap)

```
从图中，我们可以看出，该C2C网站的使用者十分分散，主要分布在北美洲，欧洲，西亚和南非。其中欧洲部分的user count最多。

```{r, message=FALSE, echo=FALSE}

# mosaic plot 删掉

mosaicplot(user_count ~ country, data = country, color = "blue", main = "Mosaic Plot of Countries")

```

#### Graph for language variables

针对语言，我们用柱状图来展示该数据。
```{r}

a <- unlist(Userdataset$langEn) 
langEn <- sum(a=="1")
b <- unlist(Userdataset$langFr) 
langFr <- sum(b=="1")
c <- unlist(Userdataset$langDe) 
langDe <- sum(c=="1")
d <- unlist(Userdataset$langEs) 
langEs <- sum(d=="1")
e <- unlist(Userdataset$langIt)
langIt <- sum(e=="1")

language1 <- c("langEn","langFr","LangDe","langEs","langIt")
number <- c(langEn,langFr,langDe,langEs,langIt)
LANGUAGE_DATA <- data.frame(language1,number)
p2 <- ggplot(LANGUAGE_DATA,aes(x=reorder(language1,number),y=number,fill=language1))+geom_col()+
  geom_text(aes(label = number), vjust = 1.5, colour = "white", position = position_dodge(.9), size = 5)
p2

```
从图中可以看出，用户first language choice为英语的人占大多数，Es的人最少。

#### Graph for gender varibles

对于gender的数据，我们也用柱状图来展示。从图中，我们可以看出，女性用户远多于男性用户。
```{r}

f <- unlist(Userdataset$genderFamale) 
genderFamale <- sum(f=="1")
g <- unlist(Userdataset$genderMale) 
genderMale <- sum(g=="1")

gender1 <- c("genderFamale", "genderMale")
number1 <- c(genderFamale,genderMale)
GENDER_DATA <- data.frame(gender1,number1)
p3 <- ggplot(GENDER_DATA,aes(x=reorder(gender1,number1),y=number1,fill=gender1))+geom_col()+
  geom_text(aes(label = number1), vjust = 1.5, colour = "white", position = position_dodge(.9), size = 5)
p3

```

#### Graph for other variables

对于其他variables，我们也用了bar chart来集中展示。
```{r}

Userdataset %>% select(civilityGenderId, hasAnyApp, hasProfilePicture) %>% 
  gather() %>% 
  ggplot(aes(value)) +
  facet_wrap(~ key, scales = "free") +
  geom_bar()

```
从图中，我们可以看出，用户中，使用Mrs title的人占大多数。而且只有少部分人下载了该B2B e-commercial的相关app。同时，绝大部分用户都有头像。

#### Box plot

对于non-numeric 数据，我们除了以上分类分析之外，我们还用了箱型图来看其数据分布情况。
```{r}

Userdataset %>% select(10, 11, 12, 15,16,17,18,19, 20, 21) %>% 
  keep(is.factor) %>% 
  gather() %>% 
  ggplot(aes(value)) +
  facet_wrap(~ key, scales = "free") +
  geom_boxplot()


```

## Examination of the relationship between variables

To observe the relationship between all of the variables, we made the "Multivariate correlation scatter matrix plots" and "Correlation plot" for numeric data.

and "Mosaic chart" for Non-numeric data.

### Multivariate correlation scatter matrix plots - Nurmeric

```{r}
library(GGally)

Userdataset %>% select(2, 3, 4, 5, 6, 8, 9, 13, 14) %>% ggpairs()

```

### Correlation plot - Numeric

```{r}

UserdatasetP <- Userdataset %>% select(,-22,-13)
plot_correlation(UserdatasetP, type= 'c', cor_args = list( 'use' = 'complete.obs'))

```
从2个图中，我们可以看到各个numeric variables之间的相关性。显而易见地，Var.seniority和其他有变量基本都没有什么相关性。而var.productsSold，socialProductsLiked，socialNbFollows和socialNbFollowers之间的相关性更强。

### Mosaic Chart - Non-numeric 

对于non—numeric variables，我们用mosaic plot来展示每个变量与latent的相关性。

```{r, message=FALSE}

cat_table <- Userdataset %>% select(10, 11, 12, 15, 16, 17, 18, 19, 20, 21, 22) 
plot_list=list()
for (i in 1:24){
  print(mosaicplot(~ cat_table[[i]] + cat_table[[11]], 
                   data = cat_table,
                   main = "Mosaic Plot between latent and each variable",
                   color = TRUE, 
                   ylab=paste0("variable_", colnames(cat_table)[i])))
  Sys.sleep(2)
}

```


# Next step
有关数据的部分：
1. 由于原数据集过大，导致中途运行时出现了运行内存不足的情况，所以我们随机筛选了部分数据来进行分析。为了保证数据的结构与原数据集基本一致，我们决定采用分组抽样（把国家作为分组标准）来筛选。
2. 不论是原始数据，还是我们筛选出来的数据，其latent的用户都非常多。为了使研究更明确，我们下一步可能会细分用户类型（细化指标），比如latent用户：daysSinceLastLogin取值为[90,365]。而超过365天没有登陆的人，则可认为是missing_user，即默认其日后也不会登陆该网站，没有处理的必要。
3. 在处理数据时，考虑到后续要使用不同的模型，我们将文字型数据都用数字来表示了，这个有必要么？对于国家column，由于国家数量过多，所以我们保留了文字型。如果后续建模不支持使用文字型数据，我们要怎么处理“国家column”这部分数据？

问题：
1.在展示numeric数据的部分，bar—chart和box-chart的结果都不是很好，有可视化的建议？比如还能用什么别的图表来显示？
2.
2.因为根据eda，很多变量之间的相关性都不算很大，对于接下来的工作，您有什么建议？
